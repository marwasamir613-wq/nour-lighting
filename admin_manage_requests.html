<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>إدارة طلبات الموظفين - شركة نور</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <style>body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }</style>
</head>
<body class="p-4 text-right italic font-bold">

    <header class="max-w-4xl mx-auto mb-8 bg-white p-6 rounded-3xl shadow-sm border border-blue-50">
        <h1 class="text-2xl font-black text-slate-800 italic uppercase">إدارة طلبات الإجازات والسلف</h1>
        <p class="text-slate-500 text-sm mt-1">راجعي طلبات الموظفين واتخذي القرار المناسب</p>
    </header>

    <main class="max-w-4xl mx-auto">
        <div id="requestsList" class="space-y-4"></div>
    </main>

    <script>
        window.onload = function() {
            loadRequests();
        };

        function loadRequests() {
            // التعديل: السحب من مخزن الطلبات المعلقة الموحد
            const pendingRequests = JSON.parse(localStorage.getItem('nour_pending_requests')) || [];
            const container = document.getElementById('requestsList');

            if (pendingRequests.length === 0) {
                container.innerHTML = `<div class="text-center py-20 opacity-40">لا توجد طلبات معلقة حالياً</div>`;
                return;
            }

            container.innerHTML = pendingRequests.map((req, index) => `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-[#137fec]">
                            <span class="material-icons">${req.type === 'سلفة' ? 'payments' : 'event_busy'}</span>
                        </div>
                        <div>
                            <h3 class="font-black text-slate-800">${req.employeeName}</h3>
                            <p class="text-xs text-slate-500 italic uppercase">${req.type} - ${req.details}</p>
                            <p class="text-[9px] text-blue-400 mt-1 italic uppercase">${req.timestamp || ''}</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="updateStatus(${index}, 'موافقة')" class="bg-emerald-500 text-white px-6 py-2 rounded-xl font-black text-xs hover:bg-emerald-600 active:scale-90 transition-all">موافقة</button>
                        <button onclick="updateStatus(${index}, 'رفض')" class="bg-red-500 text-white px-6 py-2 rounded-xl font-black text-xs hover:bg-red-600 active:scale-90 transition-all">رفض</button>
                    </div>
                </div>
            `).join('');
        }

        function updateStatus(index, status) {
            let pendingRequests = JSON.parse(localStorage.getItem('nour_pending_requests')) || [];
            let employees = JSON.parse(localStorage.getItem('nour_employees')) || [];
            const req = pendingRequests[index];

            const empIndex = employees.findIndex(e => e.name === req.employeeName);

            if (status === 'موافقة') {
                if (empIndex !== -1) {
                    if (req.type === 'إجازة') {
                        let currentBalance = parseInt(employees[empIndex].vacationBalance);
                        if (isNaN(currentBalance)) currentBalance = 21;

                        if (currentBalance > 0) {
                            employees[empIndex].vacationBalance = currentBalance - 1;
                            
                            if (!employees[empIndex].leaveDates) employees[empIndex].leaveDates = [];
                            
                            // تنظيف التاريخ المرسل من خانة details
                            let cleanDate = req.details.trim();
                            employees[empIndex].leaveDates.push(cleanDate); 
                        } else {
                            alert("يا مروة، الموظف ده خلص رصيد إجازاته!");
                            return;
                        }
                    } else if (req.type === 'سلفة') {
                        // استخراج الرقم من جملة "مبلغ: 1000 ج.م"
                        let loanAmount = parseFloat(req.details.replace(/[^0-9]/g, '')) || 0;
                        employees[empIndex].loans = (parseFloat(employees[empIndex].loans) || 0) + loanAmount;
                    }
                }
            }

            // تحديث الإشعارات للموظف
            let allNotifs = JSON.parse(localStorage.getItem('nour_notifications')) || [];
            allNotifs.unshift({
                to: req.employeeName,
                title: `تم ${status} على طلبك`,
                message: `بخصوص طلب الـ ${req.type} (${req.details})، فقد تم رد الإدارة بـ ${status}.`,
                status: status,
                date: new Date().toLocaleString('ar-EG')
            });

            // الحفظ النهائي
            localStorage.setItem('nour_employees', JSON.stringify(employees));
            localStorage.setItem('nour_notifications', JSON.stringify(allNotifs));
            
            // مسح من قائمة "المعلقة" ونقله للأرشيف العام
            let allRequests = JSON.parse(localStorage.getItem('nour_all_requests')) || [];
            req.status = status; // تحديث الحالة قبل الأرشفة
            allRequests.push(req);
            localStorage.setItem('nour_all_requests', JSON.stringify(allRequests));

            pendingRequests.splice(index, 1);
            localStorage.setItem('nour_pending_requests', JSON.stringify(pendingRequests));

            alert(`يا مروة، تم الحفظ والرد على ${req.employeeName} بـ ${status}`);
            loadRequests();
        }
    </script>
</body>
</html>