<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>شيت الإضافي - شركة نور</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style> 
        body { font-family: 'Cairo', sans-serif; background: #f8fafc; } 
        @media print { .no-print { display: none !important; } } 
        .table-container { background: white; border-radius: 2.5rem; border: 1px solid #eef2ff; }
        .total-row { background: #0f172a; color: white; }
    </style>
</head>
<body class="p-4 text-right italic font-bold">
    <header class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 no-print gap-4">
        <div class="flex items-center gap-3">
            <button onclick="window.location.href='salaries_calculation.html'" class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center border active:scale-90 transition-all">
                <span class="material-icons-round text-slate-600">arrow_forward</span>
            </button>
            <div>
                <h1 class="text-xl font-black italic text-blue-800">سجل الإضافي الرسمي</h1>
                <p class="text-[9px] text-blue-500 font-bold uppercase italic">نور للإضاءة - حساب السهرات</p>
            </div>
        </div>

        <div class="flex gap-2 bg-white p-3 rounded-2xl shadow-sm border border-blue-50">
            <input type="date" id="startDate" class="bg-slate-50 p-2 rounded-xl text-xs font-black border-none outline-none">
            <input type="date" id="endDate" class="bg-slate-50 p-2 rounded-xl text-xs font-black border-none outline-none">
            <button onclick="loadOvertimeData()" class="bg-blue-600 text-white px-5 py-2 rounded-xl text-[10px] font-black italic active:scale-95 transition-all">تحديث الحسابات</button>
        </div>

        <div class="flex gap-2">
            <button onclick="downloadPDF()" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-lg flex items-center gap-2 active:scale-95 transition-all">
                <span class="material-icons-round text-sm">save_alt</span> حفظ PDF
            </button>
        </div>
    </header>

    <div id="printableArea">
        <main class="max-w-5xl mx-auto table-container shadow-2xl overflow-hidden">
            <table class="w-full text-right text-[11px] border-collapse">
                <thead class="bg-blue-600 text-white font-black italic text-center">
                    <tr>
                        <th class="p-5 text-right">اسم الموظف</th>
                        <th class="p-5">اليومية</th>
                        <th class="p-5">عدد السهرات</th>
                        <th class="p-5 bg-blue-700">إجمالي قيمة السهرات</th>
                        <th class="p-5 bg-blue-900 text-white">الصافي للإضافي</th>
                    </tr>
                </thead>
                <tbody id="otBody" class="text-center font-bold text-slate-700"></tbody>
                <tfoot id="otFooter"></tfoot>
            </table>
        </main>
    </div>

    <script>
        function loadOvertimeData() {
            const logs = JSON.parse(localStorage.getItem('attendance_logs')) || [];
            const employees = JSON.parse(localStorage.getItem('nour_employees')) || [];
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;
            
            if(!startStr || !endStr) return;
            
            const startDate = new Date(startStr);
            const endDate = new Date(endStr);
            endDate.setHours(23, 59, 59);
            
            let html = '';
            let grandTotalOvertime = 0;

            employees.forEach(emp => {
                // البحث عن السهرات في السجلات
                const otLogs = logs.filter(l => {
                    const logDate = new Date(l.date);
                    return l.name === emp.name && 
                           l.dayStatus === "يوم ونصف" && 
                           logDate >= startDate && logDate <= endDate;
                });

                const daily = parseFloat(emp.dailyRate) || 0; 
                const otCount = otLogs.length; 
                const otValueCalc = (daily * 0.5) * otCount; // الحساب بناءً على عدد السهرات

                grandTotalOvertime += otValueCalc;

                html += `<tr class="border-b border-blue-50 hover:bg-blue-50/40 transition-all">
                    <td class="p-5 text-right font-black text-slate-800 border-l border-blue-50">${emp.name}</td>
                    <td class="p-5 text-blue-600 font-black">${daily.toLocaleString()} ج.م</td>
                    <td class="p-5 text-slate-800 font-black text-lg">${otCount}</td>
                    <td class="p-5 bg-blue-50/30 text-emerald-600 font-black">${otValueCalc.toLocaleString()} ج.م</td>
                    <td class="p-5 bg-blue-50 font-black text-blue-900 text-[13px] underline decoration-double">${otValueCalc.toLocaleString()} ج.م</td>
                </tr>`;
            });

            document.getElementById('otBody').innerHTML = html || '<tr><td colspan="5" class="p-10 opacity-30 italic text-center">لا توجد بيانات</td></tr>';
            
            if(employees.length > 0) {
                document.getElementById('otFooter').innerHTML = `
                    <tr class="total-row font-black italic text-[14px]">
                        <td colspan="3" class="p-6 text-left">إجمالي الإضافي المستحق للشركة بالكامل:</td>
                        <td colspan="2" class="p-6 text-center text-yellow-400 bg-slate-800 text-xl font-black">${grandTotalOvertime.toLocaleString()} ج.م</td>
                    </tr>
                `;
            }
        }

        function downloadPDF() {
            const element = document.getElementById('printableArea');
            const opt = {
                margin: 0.3, filename: 'شيت_الإضافي_نور.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        window.onload = () => {
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
            loadOvertimeData();
        }
    </script>
</body>
</html>